name: CI Pipeline for CashLenX Server

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build-test:
    name: Build and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: [ '1.21' ]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go ${{ matrix.go-version }}
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Install dependencies
      run: go mod download

    - name: Build
      run: go build -v ./...

    - name: Run tests
      run: go test -v ./errors ./validation

    - name: Lint (if golangci-lint is installed)
      run: |
        if command -v golangci-lint &> /dev/null; then
          golangci-lint run
        else
          echo "golangci-lint not found, skipping lint step"
        fi

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build-test
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub (if secrets available)
      uses: docker/login-action@v3
      if: env.DOCKER_HUB_USERNAME != ''
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      env:
        DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: ${{ github.event_name == 'release' }}
        tags: |
          ${{ secrets.DOCKER_HUB_USERNAME }}/cashlenx-server:${{ github.ref_name }}
          ${{ github.event_name == 'release' && format('{0}/cashlenx-server:latest', secrets.DOCKER_HUB_USERNAME) || '' }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  generate-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest
    needs: build-test
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate HTML docs from OpenAPI spec
      run: |
        mkdir -p ./docs/html
        # Check if swagger-ui-dist is installed
        if [ ! -d "node_modules/swagger-ui-dist" ]; then
          npm install swagger-ui-dist
        fi
        # Copy swagger-ui files to docs/html
        cp -r node_modules/swagger-ui-dist/* ./docs/html
        # Create custom index.html that uses our OpenAPI spec
        cat > ./docs/html/index.html << EOF
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <title>CashLenX API Documentation</title>
          <link rel="stylesheet" type="text/css" href="./swagger-ui.css" />
          <style>
            body {
              margin: 0;
              padding: 0;
            }
            .swagger-ui .topbar {
              background-color: #2c3e50;
            }
          </style>
        </head>
        <body>
          <div id="swagger-ui"></div>
          <script src="./swagger-ui-bundle.js"></script>
          <script src="./swagger-ui-standalone-preset.js"></script>
          <script>
            window.onload = function() {
              const ui = SwaggerUIBundle({
                url: '../openapi.yaml',
                dom_id: '#swagger-ui',
                presets: [
                  SwaggerUIBundle.presets.apis,
                  SwaggerUIStandalonePreset
                ],
                layout: "StandaloneLayout"
              });
              window.ui = ui;
            };
          </script>
        </body>
        </html>
        EOF
        echo "HTML documentation generated successfully in ./docs/html/"

    - name: Upload docs artifact
      uses: actions/upload-artifact@v4
      with:
        name: api-docs
        path: ./docs/html
        retention-days: 7
